Of course. Here is a comprehensive NixOS configuration using flakes, designed for a secure server whose primary purpose is to host Docker containers.  
This configuration is structured into a self-contained flake with clear instructions. It emphasizes security through a hardened kernel, a strict firewall, locked-down SSH, and automatic updates.

### **Directory Structure**

First, create the following directory structure for your configuration:

/etc/nixos/  
├── flake.nix  
├── configuration.nix  
└── README.md

### **flake.nix**

This file is the entry point for your system configuration. It defines the dependencies (like nixpkgs) and the output, which is your NixOS system.

Nix

\# /etc/nixos/flake.nix  
{  
  description \= "A secure NixOS server for hosting Docker containers";

  \# Define the inputs for our flake.  
  \# Using a stable branch is recommended for servers.  
  inputs \= {  
    nixpkgs.url \= "github:NixOS/nixpkgs/nixos-24.05";  
  };

  \# Define the outputs of our flake.  
  outputs \= { self, nixpkgs, ... }: {  
    \# Define our NixOS configuration  
    nixosConfigurations.secure-docker-host \= nixpkgs.lib.nixosSystem {  
      system \= "x86\_64-linux";  
        
      \# Pass special arguments to our modules, if needed.  
      \# specialArgs \= { }; 

      \# List of modules to import into the configuration.  
      \# Our main configuration is in configuration.nix  
      modules \= \[  
        ./configuration.nix  
      \];  
    };  
  };  
}

### **configuration.nix**

This is the core of your server's configuration. It details everything from the bootloader and networking to security hardening and user accounts. Comments are included to explain the purpose of each section.

Nix

\# /etc/nixos/configuration.nix  
{ config, pkgs, lib, ... }:

{  
  \# Import the hardware-scan generated for your specific machine.  
  \# This is usually generated by \`nixos-generate-config\`.  
  imports \= \[ ./hardware-configuration.nix \];

  \# \--- System and Boot \---  
  boot.loader.grub.enable \= true;  
  \# IMPORTANT: Replace /dev/sda with your actual boot device.  
  boot.loader.grub.device \= "/dev/sda";   
  boot.loader.systemd-boot.enable \= false; \# Or choose systemd-boot

  \# Set your time zone.  
  time.timeZone \= "Etc/UTC"; \# Using UTC is a best practice for servers.  
  i18n.defaultLocale \= "en\_US.UTF-8";

  \# \--- Networking \---  
  networking.hostName \= "secure-docker-host"; \# Define your hostname  
    
  \# Enable the firewall  
  networking.firewall.enable \= true;  
    
  \# Open essential ports. SSH is required for remote access.  
  \# Add ports for your web services here (e.g., 80, 443).  
  networking.firewall.allowedTCPPorts \= \[ 22 80 443 \];  
  \# networking.firewall.allowedUDPPorts \= \[ ... \];

  \# Configure a static IP address (recommended for servers).  
  \# Replace the interface name and addresses with your own.  
  networking.useDHCP \= false;  
  networking.interfaces.ens3 \= {  
    useDHCP \= false;  
    ipv4.addresses \= \[  
      {  
        address \= "192.168.1.10";  
        prefixLength \= 24;  
      }  
    \];  
  };  
  networking.defaultGateway \= "192.168.1.1";  
  networking.nameservers \= \[ "1.1.1.1" "8.8.8.8" \];

  \# \--- Docker (Containerization) \---  
  virtualisation.docker \= {  
    enable \= true;  
    \# Optional: Prune unused Docker resources daily to save space.  
    autoPrune \= {  
      enable \= true;  
      dates \= "daily";  
    };  
  };  
  \# For podman instead, uncomment the following:  
  \# virtualisation.podman.enable \= true;

  \# \--- Security Hardening \---

  \# 1\. SSH Hardening  
  services.openssh \= {  
    enable \= true;  
    settings \= {  
      \# Forbid root login over SSH.  
      PermitRootLogin \= "no";  
      \# Enforce public key authentication.  
      PasswordAuthentication \= false;  
      KbdInteractiveAuthentication \= false;  
    };  
  };

  \# 2\. Automatic System Updates  
  system.autoUpgrade \= {  
    enable \= true;  
    flake \= "/etc/nixos"; \# Point to your flake configuration  
    \# Update twice a week. You can adjust this schedule.  
    dates \= "Mon,Fri \*-\*-\* 04:00:00";   
    allowReboot \= true; \# Allow reboots for kernel updates  
  };

  \# 3\. NixOS Hardening Profile  
  \# Enables a variety of security-related kernel parameters and settings.  
  security.hardening.enable \= true;

  \# 4\. Kernel Sysctl Hardening  
  \# Fine-tune kernel parameters for better security.  
  boot.kernel.sysctl \= {  
    \# Disables unprivileged user namespaces, a potential attack vector.  
    "kernel.unprivileged\_userns\_clone" \= 0;  
    \# Restrict loading of TTY line disciplines to CAP\_SYS\_MODULE  
    "dev.tty.ldisc\_autoload" \= 0;  
    \# Improve protection against SYN flood attacks  
    "net.ipv4.tcp\_syncookies" \= 1;  
    \# Log packets with impossible addresses  
    "net.ipv4.conf.all.log\_martians" \= 1;  
    "net.ipv4.conf.default.log\_martians" \= 1;  
  };  
    
  \# 5\. Intrusion Detection and Prevention  
  \# Helps prevent brute-force attacks by monitoring logs and banning IPs.  
  services.fail2ban.enable \= true;

  \# 6\. Audit Framework  
  \# Logs security-relevant events on the system.  
  security.audit.enable \= true;  
  

  \# \--- Users and Authentication \---  
  \# Define a non-root administrative user.  
  users.users.admin \= {  
    isNormalUser \= true;  
    description \= "Administrator";  
    \# User must be in 'wheel' for sudo access and 'docker' to manage containers.  
    extraGroups \= \[ "wheel" "docker" \];   
    \# IMPORTANT: Replace this with your own public SSH key.  
    openssh.authorizedKeys.keys \= \[  
      "ssh-ed25519 AAAA... your-public-key-here"  
    \];  
  };  
    
  \# Disable root password login entirely. Administration should be done via \`sudo\`.  
  users.users.root.initialHashedPassword \= "\*";

  \# Enforce password-based sudo access for the 'wheel' group.  
  security.sudo.wheelNeedsPassword \= true;

  \# \--- System Environment and Packages \---  
    
  \# Enable flakes and the new nix command-line tool.  
  nix.settings.experimental-features \= \[ "nix-command" "flakes" \];

  \# Auto-run garbage collection to free up disk space from old generations.  
  nix.gc \= {  
    automatic \= true;  
    dates \= "weekly";  
    options \= "--delete-older-than 7d";  
  };  
    
  \# List packages you want to install globally.  
  \# Keep this list minimal for a server.  
  environment.systemPackages \= with pkgs; \[  
    vim  
    git  
    htop  
    wget  
    curl  
    docker-compose \# Essential tool for managing multi-container applications  
  \];

  \# This value determines the NixOS release from which the default  
  \# settings for stateful data, like file locations and database versions  
  \# on your system were taken. It‘s perfectly fine and recommended to leave  
  \# this value at the release version of the first install of this system.  
  \# Before changing this value read the documentation for this option  
  \# (e.g. man configuration.nix or on https://nixos.org/nixos/options.html).  
  system.stateVersion \= "24.05"; \# Do not change unless you know what you're doing.

}

### **README.md**

A good README is crucial for explaining how to use and maintain the configuration.

Markdown

\# NixOS Secure Docker Host Configuration

This repository contains a secure, flake-based NixOS configuration for a server designed to host Docker containers.

\#\# Key Features

\- \*\*Flake-based:\*\* Fully reproducible and self-contained configuration.  
\- \*\*Docker Ready:\*\* Docker and Docker Compose are installed and configured.  
\- \*\*Security Hardened:\*\*  
  \- Strict firewall enabled by default.  
  \- SSH access is limited to key-based authentication for non-root users.  
  \- Root login is disabled.  
  \- Automatic security updates are enabled.  
  \- Includes the NixOS hardening profile and Fail2Ban for brute-force protection.

\#\# ⚠️ Pre-Installation Checklist

Before you install, you \*\*MUST\*\* edit \`configuration.nix\` and change the following placeholder values:

1\.  \*\*Boot Device:\*\* Change \`boot.loader.grub.device \= "/dev/sda";\` to your server's primary disk (e.g., \`/dev/nvme0n1\`).  
2\.  \*\*Static IP:\*\* Modify the network settings (\`networking.interfaces.ens3\`, \`networking.defaultGateway\`, etc.) to match your network environment.  
3\.  \*\*SSH Public Key:\*\* Replace the placeholder SSH key in \`users.users.admin.openssh.authorizedKeys.keys\` with your own public key. \*\*You will be locked out if you do not do this.\*\*

\#\# Installation

1\.  Boot the NixOS installer on your server.  
2\.  Partition and format your drives as needed. Mount your root partition to \`/mnt\`.  
3\.  Generate the initial hardware configuration:  
    \`\`\`bash  
    nixos-generate-config \--root /mnt  
    \`\`\`  
4\.  Remove the generated \`configuration.nix\` and replace the contents of \`/mnt/etc/nixos/\` with the files from this repository.  
    \`\`\`bash  
    rm /mnt/etc/nixos/configuration.nix  
    \# Now copy your flake.nix, configuration.nix, etc. into /mnt/etc/nixos/  
    \`\`\`  
5\.  Run the installation using the flake:  
    \`\`\`bash  
    nixos-install \--flake /mnt/etc/nixos\#secure-docker-host  
    \`\`\`  
6\.  Reboot the system once the installation is complete.

\#\# System Maintenance

After installation, you can manage the system by editing the files in \`/etc/nixos\` and rebuilding.

\#\#\# Applying Changes

After making a change to your configuration files:

\`\`\`bash  
sudo nixos-rebuild switch \--flake /etc/nixos\#secure-docker-host

### **Updating the System**

To update all packages and dependencies defined in your flake's inputs:

1. Update the flake's lock file:  
   Bash  
   sudo nix flake update /etc/nixos

2. Apply the new generation:  
   Bash  
   sudo nixos-rebuild switch \--flake /etc/nixos\#secure-docker-host  
